<!--
    https://naereen.github.io/world-tour-timeline/
    MIT License, by Lilian Besson (@Naereen)
    https://github.com/Naereen/world-tour-timeline/
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="author" content="Lilian Besson (@Naereen)" />
    <meta name="description" content="World Tour in a Time Line" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <title>World Tour in a Time Line</title>

    <!--[if lt IE 9]>
		    <script src="js/html5shiv.js"></script>
		<![endif]-->
    <script type="text/javascript" src="js/d3/d3.v3.min.js"></script>
    <script type="text/javascript" src="js/d3/queue.v1.min.js"></script>
    <script type="text/javascript" src="js/d3/topojson.v1.min.js"></script>
    <script type="text/javascript" src="js/mousetrap.min.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/nprogress.min.js"></script>

    <link type="text/css" rel="stylesheet" href="css/style.css" />
    <link type="text/css" rel="stylesheet" media="screen and (min-width: 380px)" href="css/nprogress.css" />

    <script type="text/javascript">
        NProgress.start();
    </script>
</head>

<body>
    <!-- <h1>World tour</h1> -->
    <h2 id="legend">Map is loading...</h2>
    <h2 id="comment">When, for how long?</h2>
    <noscript style="color: red;">
            Warning: javascript seems to be disabled...
            The map will not be available.

            Please enable javascript or download a more recent web browser to view this animation.
    </noscript>
    <script type="text/javascript">
        NProgress.inc();
        var duration_of_animation = 2000;
        var size = Math.trunc(0.85 * Math.min(window.innerHeight, window.innerWidth));
        var width = size,
            height = size;

        var canvas = d3.select("body").append("canvas")
            .attr("width", width)
            .attr("height", height);

        var projection = d3.geo.orthographic()
            .translate([width / 2, height / 2])
            .scale(width / 2 - 50)
            .clipAngle(90)
            .precision(0.6);

        var container = canvas.node();
        var c = container.getContext('2d');

        var path = d3.geo.path()
            .projection(projection)
            .context(c);

        var legend = container.parentElement.querySelector('#legend');
        var comment = container.parentElement.querySelector('#comment');
        NProgress.inc();
        queue()
            .defer(d3.json, 'data/world-110m.json')
            .defer(d3.csv, 'data/my-countries-in-order.csv')
            .await(ready);

        function ready(error, world, names) {
            if (error) throw error;

            var globe = {
                    type: 'Sphere'
                },
                land = topojson.feature(world, world.objects.land),
                countries = topojson.feature(world, world.objects.countries).features,
                borders = topojson.mesh(world, world.objects.countries, function(a, b) {
                    return a !== b;
                }),
                i = -1,
                n = countries.length;

            function getData(a) {
                return names.find(function(x) {
                    return (a.name == x.name);
                });
            };

            countries = countries.filter(function(d) {
                return names.some(function(x) {
                    if (d.id == x.id) return d.name = x.name;
                });
            }).sort(function(a, b) {
                var my_a = getData(a);
                var my_b = getData(b);
                return parseInt(my_a.number) - parseInt(my_b.number);
            });

            var nb = countries.length;

            function updatetext(legend, comment, countries, i) {
                legend.innerHTML = (countries[i].name);
                comment.innerHTML = '#' + (i + 1) + '/' + nb + ' : ' + (getData(countries[i]).comment);
            };
            NProgress.inc();

            function transition() {
                NProgress.start();
                d3.transition()
                    .duration(duration_of_animation)
                    .each('start', function() {
                        while (!countries[i = (i + 1) % n]) {};
                        updatetext(legend, comment, countries, i);
                        NProgress.inc();
                    })
                    .tween('rotate', function() {
                        var p = d3.geo.centroid(countries[i]),
                            r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
                        NProgress.inc();
                        return function(t) {
                            projection.rotate(r(t));
                            c.clearRect(0, 0, width, height);
                            c.fillStyle = '#fff', c.lineWidth = 2, c.beginPath(), path(globe), c.fill();
                            c.fillStyle = '#42affa', c.beginPath(), path(land), c.fill();
                            c.fillStyle = '#f00', c.beginPath(), path(countries[i]), c.fill();
                            c.strokeStyle = '#ccc', c.lineWidth = .5, c.beginPath(), path(borders), c.stroke();
                            c.strokeStyle = '#ccc', c.lineWidth = 2, c.beginPath(), path(globe), c.stroke();
                        };
                        NProgress.inc();
                    })
                    .transition()
                    .each('end', transition);
                setTimeout(NProgress.done, duration_of_animation);
            };
            transition();

            // MouseTrap keyboard shortcuts (cf. http://craig.is/killing/mice)
            Mousetrap.bind(["h", "?"], function() {
                window.alert(
                    "This Â« World-Tour Timeline Â» page has the following keyboard shortcuts:" +
                    "\n - h or ? : for this help window." +
                    "\n - left or p : previous country." +
                    "\n - right or n or space or enter : next country." +
                    "\n\nThis is a free and open-source software, see https://github.com/Naereen/world-tour-timeline/ for more details and the latest version." +
                    "\nBuilt with â™¥ by Lilian Besson (Naereen)."
                );
            });
            Mousetrap.bind(['space', 'enter', 'right', 'n'], transition);
            Mousetrap.bind(['left', 'p'], function() {
                i = (i - 1) % nb;
                i = ((i < 0) && (nb - 1)) || i;
                updatetext(legend, comment, countries, i);
            });
        };

        d3.select(self.frameElement).style('height', height + 'px');
        // Done

        $(window).load(function() {
            NProgress.done();
            // Google Analytics
            (function(i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function() {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
            ga('create', 'UA-38514290-17', 'github.io');
            ga('send', 'pageview');
        });
    </script>
    <p id="thanks">
        <span style="font-style: normal;">Press 'space' to go to the next country, 'left' or 'p' to go to the previous one.</span>
        <br>
        <span style="color: red;">Still experimental! <a href="https://github.com/Naereen/world-tour-timeline/commits/master">Currently in active progress...</a></span>
        <br> ðŸ”¨ Made by <a href="https://GitHub.com/Naereen">Lilian Besson (@Naereen)</a>, âœ¨ publically released under the <a href="https://lbesson.mit-license.org/">MIT license</a>. Based on <a href="http://bl.ocks.org/mbostock/4183330">World Tour</a>        by <a href="http://bost.ocks.org/mike/">Mike Bostock</a>.
    </p>
</body>

</html>